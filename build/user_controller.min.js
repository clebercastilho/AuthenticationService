module.exports=function(){function e(e){return e.nome&&e.email&&e.senha}function r(e){return e.email&&e.senha}function a(r,a){if(!e(r)){var n=s.generateErrorMessage("Há dados inválidos");return void a(s.getResponseData(400,n))}var t=o(),g=new UsuarioModel;g.id=s.generateToken(),g.nome=r.nome,g.email=r.email,g.senha=s.generateHash(r.senha),g.telefones=r.telefones||[],g.dataCriacao=t,g.dataAtualizacao=t,g.ultimoLogin=t,g.token=s.generateHash(s.generateToken()),i.getByEmail(g.email,function(e,r){if(e){var n=s.generateErrorMessage(i.parseError(e));return void a(s.getResponseData(400,n))}if(r&&r.email===g.email){var n=s.generateErrorMessage("E-mail já existente");return void a(s.getResponseData(400,n))}i.save(g,function(e){if(e){var r=s.generateErrorMessage(i.parseError(e));return void a(s.getResponseData(400,r))}a(s.getResponseData(200,g))})})}function n(e,r,a){i.getById(e,function(e,n){if(e){var t=s.generateErrorMessage(i.parseError(e));return void a(s.getResponseData(400,t))}if(!n){var t=s.generateErrorMessage("Usuário não encontrado");return void a(s.getResponseData(400,t))}if(n.token!==r){var t=s.generateErrorMessage("Não autorizado");return void a(s.getResponseData(401,t))}var g=o().subtract(30,"minutes");if(g.isAfter(n.ultimoLogin)){var t=s.generateErrorMessage("Sessão inválida");return void a(s.getResponseData(401,t))}a(s.getResponseData(200,n))})}function t(e,a){if(!r(e)){var n=s.generateErrorMessage("Há dados inválidos");return void a(s.getResponseData(400,n))}i.getByEmail(e.email,function(r,n){if(r){var t=s.generateErrorMessage(i.parseError(r));return void a(s.getResponseData(400,t))}var g=s.generateHash(e.senha);if(!n||n.senha!==g){var t=s.generateErrorMessage("Usuário e/ou senha inválidos");return void a(s.getResponseData(401,t))}n.ultimoLogin=o(),i.updateLoginDate(n.id,n.ultimoLogin,function(e){if(e){var r=s.generateErrorMessage(i.parseError(e));return void a(s.getResponseData(400,r))}a(s.getResponseData(200,n))})})}var o=require("moment"),s=require("./util.min"),i=require("./db_model.min"),g={criar:a,obter:n,autenticar:t};return g}();